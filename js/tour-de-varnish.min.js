AngleUtils={REV:Math.PI*2,mod:function(a){while(a>=Math.PI)a-=this.REV;while(a<-Math.PI)a+=this.REV;return a;}};StopWatch=function(a){var b=new Date().getTime();this.elapsed=function(){return(new Date().getTime()-b)>a;};};Earth=function(a){var b=new THREE.Object3D();var c=[];var d;var e=document.createElement('canvas');b.position.z=-500;a.add(b);e.width=1024;e.height=512;var f=e.getContext('2d');f.drawImage($('#world_map')[0],0,0);var g=new THREE.Texture(e);var h=new THREE.SphereGeometry(200,20,20);var i=new THREE.MeshBasicMaterial({map:g,overdraw:true});var j=new THREE.Mesh(h,i);b.add(j);var k=function(){var a=c.length-1;if(a==0)return [];var b=[];var d=c[a-1];var e=c[a];for(var f in d.steps){var g=d.steps[f];for(var h in e.steps){var i=e.steps[h];if(e.bx){b.push([new THREE.Vector2(g.cx-1024,g.cy),new THREE.Vector2(i.cx,i.cy)]);b.push([new THREE.Vector2(g.cx,g.cy),new THREE.Vector2(i.cx+1024,i.cy)]);}else b.push([new THREE.Vector2(g.cx,g.cy),new THREE.Vector2(i.cx,i.cy)]);}}return b;};var l=function(a){if(d.paths.length==0)return;var b=e.getContext('2d');b.strokeStyle='red';b.lineWidth=4;for(var c=0;c<d.paths.length;c++){var f=d.paths[c][0];var g=d.paths[c][1];var h=f.clone().lerp(g,a);b.beginPath();b.moveTo(f.x,f.y);b.lineTo(h.x,h.y);b.stroke();}};var m=function(){var a=e.getContext('2d');a.strokeStyle='red';a.fillStyle='red';var b=c[c.length-1];for(var d in b.steps){var f=b.steps[d];a.beginPath();a.arc(f.cx,f.cy,4,0,AngleUtils.REV);a.stroke();a.fill();}};this.travelTo=function(a){a.rx=AngleUtils.mod(a.rx);a.ry=AngleUtils.mod(a.ry);c.push(a);d={time:new Date().getTime(),start:b.quaternion.clone(),goal:new THREE.Quaternion().setFromEuler(new THREE.Euler(a.rx,a.ry)).normalize(),paths:k()};};this.walk=function(a){var c=new Date().getTime()-d.time;var e=Math.min(1,c/a);var f=new THREE.Quaternion();THREE.Quaternion.slerp(d.start,d.goal,f,e);b.setRotationFromQuaternion(f);g.needsUpdate=true;l(e);if(c>=a)m();return c>(a+200);};this.rotate=function(a){g.needsUpdate=true;b.rotation.x+=a.x;b.rotation.y+=a.y;};this.splash=function(){var a=$('canvas')[0];var b=a.getContext('2d');b.drawImage(e,0,0,a.width,a.height);};this.printRotation=function(){return "Rotation:\nx="+b.rotation.x+"\ny="+b.rotation.y;};};Globe=function(a){var b=false;a.earth.rotate({x:-0.2,y:0});this.animate=function(){a.earth.rotate({x:0,y:0.04});return b?'next':'';};this.handler=function(a){b=a.type=="keyup"&&a.keyCode==32;};};EarthWalker=function(a){var b=false;var c;var d;var e;this.begin=function(b){d=a.destinations[b.destination];c=new StopWatch(b.wait);e=b.duration;};this.animate=function(){if(!c.elapsed()){a.earth.walk(0);return '';}else if(!b){a.earth.travelTo(d);b=true;}return a.earth.walk(e)?'next':'';};};Monad=function(a){this.animate=function(){a.earth.splash();return '';};this.noRender=true;};TheBrain=function(a){var b=0,c=0,d=0,e=0;var f=function(a){return(a=="keydown")?1:0;};this.animate=function(){a.earth.rotate({x:0.02*(e-c),y:0.02*(d-b)});return '';};this.handler=function(g){var h=g.type;switch(g.keyCode){case 37:b=f(h);break;case 38:c=f(h);break;case 39:d=f(h);break;case 40:e=f(h);break;}if(h=="keyup"&&g.keyCode==32)console.log(a.earth.printRotation());};};Slider=function(a){var b=-1;var c;var d=function(a){var b=$(a).attr('class');$(a).attr('class',b+' active');};var e=function(a){var b=$(a).attr('class');if(b)$(a).attr('class',b.replace(' active',''));};var f=function(){b++;if(b<c.length){e('g.active');d('#'+c[b]);}else $('#slides').attr('class','');};this.begin=function(a){c=a;f();$('#slides').attr('class','active');};this.animate=function(){return b==c.length?'next':'';};this.handler=function(a){if(a.type=="keyup"&&a.keyCode==32)f();};this.noRender=true;};Waiter=function(){var a=false;this.animate=function(){return a?'next':'';};this.handler=function(b){a=b.type=="keyup"&&b.keyCode==32;};};Stage=function(a){var b,c,d;var e,f;b=new THREE.PerspectiveCamera(60,4.0/3.0,1,2000);c=new THREE.Scene();d=new THREE.CanvasRenderer();f=0;a.earth=new Earth(c);$('body').append(d.domElement);var g=function(){var b=null;if(f<a.route.length){var c=a.route[f].clazz;var d=a.route[f].args;b=eval('new '+c+'(context)');f++;}if(e&&typeof e.handler=='function')$(window).off('keydown keyup',e.handler);e=b;if(e&&typeof e.handler=='function')$(window).on('keydown keyup',e.handler);if(e&&typeof e.begin=='function')e.begin(d);};var h=function(){if(e&&e.animate()=='next')g();if(e)requestAnimationFrame(h);if(e&&!e.noRender)d.render(c,b);};this.resize=function(){d.setSize(window.innerWidth,window.innerHeight);};this.begin=function(){this.resize();g();h();};};function endJourney(){return "On arrÃªte le voyage ???";}