function endJourney(){return"On arrÃªte le voyage ???"}AngleUtils={REV:2*Math.PI,mod:function(t){for(;t>=Math.PI;)t-=this.REV;for(;t<-Math.PI;)t+=this.REV;return t}},StopWatch=function(t){var e=(new Date).getTime();this.elapsed=function(){return(new Date).getTime()-e>t},this.progress=function(){return((new Date).getTime()-e)/t}},Earth=function(t){var e,n=new THREE.Object3D,r=document.createElement("canvas");n.position.z=-500,t.add(n),r.width=1024,r.height=512;var a=r.getContext("2d");a.drawImage($("#world_map")[0],0,0);var i=new THREE.Texture(r),o=new THREE.SphereGeometry(200,20,20),c=new THREE.MeshBasicMaterial({map:i,overdraw:!0}),s=new THREE.Mesh(o,c);n.add(s);var u=function(t){if(0!=e.paths.length){var n=r.getContext("2d");n.strokeStyle=e.color,n.lineWidth=4;for(var a=0;a<e.paths.length;a++){var i=e.paths[a][0],o=e.paths[a][1],c=i.clone().lerp(o,t);n.beginPath(),n.moveTo(i.x,i.y),n.lineTo(c.x,c.y),n.stroke()}}},l=function(t){if(t){var n=r.getContext("2d");n.strokeStyle=e.color,n.fillStyle=e.color;for(var a in t.steps){var i=t.steps[a];n.beginPath(),n.arc(i.cx,i.cy,4,0,AngleUtils.REV),n.stroke(),n.fill()}}};this.travelTo=function(t,r){e={walk:new StopWatch(r),step:new StopWatch(r+200),start:n.quaternion.clone(),goal:t.goal,source:t.source,target:t.target,color:t.color,paths:t.paths},l(e.source)},this.walk=function(){var t=Math.min(e.walk.progress(),1),r=new THREE.Quaternion;return THREE.Quaternion.slerp(e.start,e.goal,r,t),n.setRotationFromQuaternion(r),i.needsUpdate=!0,u(t),e.walk.elapsed()&&l(e.target),e.step.elapsed()},this.rotate=function(t){i.needsUpdate=!0,n.rotation.x+=t.x,n.rotation.y+=t.y},this.splash=function(){var t=$("canvas")[0],e=t.getContext("2d");e.drawImage(r,0,0,t.width,t.height)},this.printRotation=function(){return"Rotation:\nx="+n.rotation.x+"\ny="+n.rotation.y}},Journey=function(){var t=[],e=function(e){var n,r,a;return e?(e.rx=AngleUtils.mod(e.rx),e.ry=AngleUtils.mod(e.ry),n=0==t.length?null:t[t.length-1],r=e,t.push(e),a="red",direction=1):(n=t.pop(),r=0==t.length?null:t[t.length-1],a="yellow",direction=-1),null==r&&(r=n,n=null),{source:n,target:r,color:a,direction:direction}},n=function(t,e,n,r){t.push([new THREE.Vector2(e.cx-1024*r,e.cy),new THREE.Vector2(n.cx,n.cy)]),t.push([new THREE.Vector2(e.cx,e.cy),new THREE.Vector2(n.cx+1024*r,n.cy)])},r=function(t){if(!t.source)return[];var e=[],r=t.source,a=t.target;for(var i in r.steps){var o=r.steps[i];for(var c in a.steps){var s=a.steps[c];a.bx===t.direction?n(e,o,s,a.bx):e.push([new THREE.Vector2(o.cx,o.cy),new THREE.Vector2(s.cx,s.cy)])}}return e},a=function(t){var e=new THREE.Euler(t.target.rx,t.target.ry);return(new THREE.Quaternion).setFromEuler(e).normalize()};this.prepareTrip=function(t){var n=e(t),i=r(n),o=a(n);return{source:n.source,target:n.target,color:n.color,paths:i,goal:o}}},Globe=function(t){var e="";this.animate=function(){return t.earth.rotate({x:0,y:.04}),e},this.handler=function(t){"keyup"==t.type&&(33==t.keyCode&&(e="prev"),34==t.keyCode&&(e="next"))}},EarthWalker=function(t,e){var n,r,a,i=!1;this.init=function(i){var o;"prev"==e?(o=null,n=new StopWatch(1e3)):(o=t.destinations[i.destination],n=new StopWatch(i.wait)),r=i.duration,a=t.journey.prepareTrip(o)},this.animate=function(){return n.elapsed()?(i||(t.earth.travelTo(a,r),i=!0),t.earth.walk()?e:""):(t.earth.walk(),"")}},Monad=function(t){var e="";this.init=function(){t.earth.splash()},this.fini=function(){var t=$("canvas")[0],e=t.getContext("2d");e.fillStyle="black",e.fillRect(0,0,window.innerWidth,window.innerHeight)},this.animate=function(){return e},this.noRender=!0,this.handler=function(t){"keyup"==t.type&&(33==t.keyCode&&(e="prev"),34==t.keyCode&&(e="next"))}},TheBrain=function(t){var e=0,n=0,r=0,a=0,i=function(t){return"keydown"==t?1:0};this.animate=function(){return t.earth.rotate({x:.02*(a-n),y:.02*(r-e)}),""},this.handler=function(o){var c=o.type;switch(o.keyCode){case 37:e=i(c);break;case 38:n=i(c);break;case 39:r=i(c);break;case 40:a=i(c)}"keyup"==c&&32==o.keyCode&&console.log(t.earth.printRotation())}},Slider=function(t,e){var n,r=-1,a=function(t){var e=$(t).attr("class");$(t).attr("class",e+" active")},i=function(t){var e=$(t).attr("class");e&&$(t).attr("class",e.replace(" active",""))},o=function(){r>=0&&r<n.length&&(i("g.active"),a("#"+n[r]))};this.init=function(t){switch(n=t,e){case"next":r=0;break;case"prev":r=n.length-1}o(),$("#slides").attr("class","active")},this.fini=function(){$("#slides").attr("class","")},this.animate=function(){switch(r){case-1:return r++,"prev";case n.length:return r--,"next";default:return""}},this.handler=function(t){"keyup"==t.type&&(33==t.keyCode&&(r--,o()),34==t.keyCode&&(r++,o()))},this.noRender=!0},Waiter=function(){var t="";this.animate=function(){return t},this.handler=function(e){"keyup"==e.type&&(33==e.keyCode&&(t="prev"),34==e.keyCode&&(t="next"))}},Stage=function(context){var camera,scene,renderer,action,current;camera=new THREE.PerspectiveCamera(60,4/3,1,2e3),scene=new THREE.Scene,renderer=new THREE.CanvasRenderer,current=-1,context.earth=new Earth(scene),context.earth.rotate({x:-.4,y:0}),context.journey=new Journey,$("body").append(renderer.domElement);var pickIndex=function(t){var e;switch(t){case"next":e=current+1;break;case"prev":e=current-1;break;default:throw new Error("unknown transition: "+t)}return Math.max(0,Math.min(e,context.route.length-1))},pickAction=function(transition){var index=pickIndex(transition);if(current!=index){var clazz=context.route[index].clazz,args=context.route[index].args,newAction=eval("new "+clazz+"(context, transition)");current=index,action&&"function"==typeof action.handler&&$(window).off("keydown keyup",action.handler),action&&"function"==typeof action.fini&&action.fini(),action=newAction,action&&"function"==typeof action.handler&&$(window).on("keydown keyup",action.handler),action&&"function"==typeof action.init&&action.init(args)}},animate=function(){transition=action.animate(),transition&&pickAction(transition),requestAnimationFrame(animate),action.noRender||renderer.render(scene,camera)};this.resize=function(){renderer.setSize(window.innerWidth,window.innerHeight)},this.init=function(){this.resize(),pickAction("next"),animate()}};